var ImageMap[xs][ys]
var Rectangles
foreach(y in ys){
    foreach(x in xs){
        var color = GetColor(x,y)
        var remainingXs = xs.Where(w => w > x)
        var remainingYs = ys.Where(h => h > x)
        var maxX = x
        var maxY = y
        while(GetColor(maxX + 1, y) == color){
            maxX = maxX + 1
        }

        while(GetColor(x, maxY + 1) == color){
            maxY = maxY + 1
        }
        var found = False

        while(!found){
            var XRange = Range(x, MaxX)
            var YRange = Range(y, MaxY)
            found = true

            foreach(ry in YRange){
                var broken = false
                foreach(rx in XRange){
                    if (GetColor(rx, ry) == color){
                        rectangles.add(x, y, rx, ry)
                        continue
                    }

                    broken = true
                    maxX = rx - 1
                    found = false
                    break
                }

                if(broken)
                    break
            }
            XRange = Range(x, MaxX)
            foreach(rx in YRange){
                var broken = false
                foreach(ry in XRange){
                    if (GetColor(rx, ry) == color){
                        rectangles.add(x, y, rx, ry)
                        continue
                    }

                    broken = true
                    maxY = ry - 1
                    found = false
                    break
                }

                if(broken)
                    break
            }
        }
    }
    return rectangles.OrderBy(r => (r.x2 - r.x1) * (r.y2 - r.y1)).first()
}